import { VertexAI } from '@google-cloud/vertexai'

const GOOGLE_CLOUD_PROJECT = process.env.NEXT_PUBLIC_GOOGLE_CLOUD_PROJECT
const GOOGLE_CLOUD_LOCATION = process.env.NEXT_PUBLIC_GOOGLE_CLOUD_LOCATION
const MODEL_NAME = process.env.NEXT_PUBLIC_MODEL_NAME

// ç®€åŒ–çš„æµå¼ç¬”è®°ç”Ÿæˆ
export async function generateNoteStream(prompt: string) {
  const vertexAI = new VertexAI({
    project: GOOGLE_CLOUD_PROJECT,
    location: GOOGLE_CLOUD_LOCATION,
  })

  const generativeModel = vertexAI.getGenerativeModel({
    model: MODEL_NAME || '',
  })

  const fullPrompt = `
# AI ç¬”è®°ç”Ÿæˆæç¤ºè¯

## è§’è‰²è®¾å®š

ä½ æ˜¯ä¸€ä½å–„äºå°†æŠ€æœ¯çŸ¥è¯†è½¬åŒ–ä¸ºå®ç”¨ç¬”è®°çš„ä¸“å®¶ï¼Œæ“…é•¿åˆ›å»ºæ—¢æœ‰ä¸ªäººè§‚ç‚¹åˆæå…¶å®ç”¨çš„æŠ€æœ¯æ–‡æ¡£ã€‚

## ä»»åŠ¡ç›®æ ‡

æ ¹æ®æˆ‘æä¾›çš„åŸå§‹å­¦ä¹ å†…å®¹ï¼Œç”Ÿæˆä¸€ä»½å®Œæ•´ã€å®ç”¨ã€æœ‰ä¸ªäººè‰²å½©çš„æŠ€æœ¯ç¬”è®°ã€‚

## ç¬”è®°è¦æ±‚

### 1. ç»“æ„è¦æ±‚

- ä½¿ç”¨æ¸…æ™°çš„å¤šå±‚çº§æ ‡é¢˜ç»“æ„ï¼Œé…åˆemojiå¢å¼ºå¯è¯»æ€§
- åŒ…å«å®Œæ•´çš„è§£å†³æ–¹æ¡ˆæµç¨‹ï¼š
  - æ¦‚å¿µ/èƒŒæ™¯ä»‹ç»ï¼ˆå¯åŒ…å«ä¸ªäººè§‚ç‚¹ï¼‰
  - ä¸ºä»€ä¹ˆé€‰æ‹©/æ ¸å¿ƒä¼˜åŠ¿
  - å®‰è£…é…ç½®æ­¥éª¤
  - å®æˆ˜ç¤ºä¾‹/ä»£ç æ¨¡æ¿
  - æ•…éšœæ’æŸ¥/å¸¸è§é—®é¢˜
  - å¯¹æ¯”åˆ†æ/æœ€ä½³å®è·µ

### 2. å†…å®¹è¦æ±‚

- **å®Œæ•´æ€§**ï¼šä»åŸºç¡€å®‰è£…åˆ°é«˜çº§é…ç½®çš„å…¨æµç¨‹è¦†ç›–
- **å®ç”¨æ€§**ï¼šæ¯ä¸ªæ­¥éª¤éƒ½å¯ç›´æ¥æ‰§è¡Œï¼Œæä¾›å®Œæ•´çš„å‘½ä»¤å’Œé…ç½®
- **ä¸ªäººåŒ–**ï¼šé€‚å½“åŠ å…¥ä¸ªäººè§‚ç‚¹ã€ä½¿ç”¨ä½“éªŒã€æ¨èç†ç”±
- **é—®é¢˜å¯¼å‘**ï¼šå›´ç»•è§£å†³å…·ä½“é—®é¢˜æ¥ç»„ç»‡å†…å®¹

### 3. æ ¼å¼è¦æ±‚

- å¤§é‡ä½¿ç”¨emojiæ¥æ ‡è®°ä¸åŒç±»å‹çš„å†…å®¹ï¼ˆğŸ”§å®‰è£…ã€âš ï¸æ³¨æ„ã€âœ…æ•ˆæœç­‰ï¼‰
- ä½¿ç”¨ä»£ç å—å±•ç¤ºæ‰€æœ‰å‘½ä»¤ã€é…ç½®æ–‡ä»¶ã€ä»£ç ç¤ºä¾‹
- ä½¿ç”¨è¡¨æ ¼è¿›è¡Œå¯¹æ¯”åˆ†æå’Œç‰¹æ€§è¯´æ˜
- ä½¿ç”¨å¼•ç”¨å—çªå‡ºé‡è¦æç¤ºå’Œæ ¸å¿ƒè§‚ç‚¹
- ä½¿ç”¨åˆ†éš”çº¿ç»„ç»‡ç»“æ„ï¼Œå¢å¼ºè§†è§‰å±‚æ¬¡

### 4. è¯­è¨€é£æ ¼

- ç”ŸåŠ¨æœ‰è¶£ä½†ä¸å¤±ä¸“ä¸šï¼Œå¯ä»¥æœ‰ä¸ªäººæ€åº¦å’Œè§‚ç‚¹
- ä½¿ç”¨ç”ŸåŠ¨çš„æ¯”å–»å’Œå½¢è±¡çš„æè¿°
- é€‚å½“çš„å¹½é»˜æ„Ÿå’Œä¸ªäººåŒ–è¡¨è¾¾
- ä¿æŒæŠ€æœ¯å‡†ç¡®æ€§çš„åŒæ—¶å¢å¼ºå¯è¯»æ€§

### 5. ä»£ç ç¤ºä¾‹è¦æ±‚

- æä¾›å®Œæ•´å¯æ‰§è¡Œçš„å‘½ä»¤åºåˆ—
- é…ç½®æ–‡ä»¶è¦å®Œæ•´ä¸”å¯ç›´æ¥ä½¿ç”¨
- æ¯ä¸ªä»£ç å—éƒ½æœ‰æ¸…æ™°çš„è¯´æ˜å’Œæ³¨é‡Š
- åŒ…å«éªŒè¯æ­¥éª¤ï¼Œç¡®ä¿é…ç½®ç”Ÿæ•ˆ

### 6. å®ç”¨æ€§å¯¼å‘

- æ¯ä¸ªæ­¥éª¤éƒ½è¦å¯æ“ä½œï¼Œé¿å…ç©ºæ´çš„ç†è®º
- æä¾›æ•…éšœæ’æŸ¥æŒ‡å—å’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ
- åŒ…å«ç®¡ç†ç»´æŠ¤çš„å¸¸ç”¨å‘½ä»¤
- ç»™å‡ºä¼˜åŒ–å»ºè®®å’Œæœ€ä½³å®è·µ

## è¾“å‡ºæ ¼å¼ç¤ºä¾‹

\`\`\`markdown
# ğŸš€ [ä¸»é¢˜åç§°]ï¼š[ç”ŸåŠ¨çš„å‰¯æ ‡é¢˜æˆ–ä¸ªäººè§‚ç‚¹]

> ğŸ˜ **é€‚ç”¨åœºæ™¯**ï¼š[ä¸»è¦åº”ç”¨åœºæ™¯]
> ğŸ¯ **æ ¸å¿ƒä¼˜åŠ¿**ï¼š[ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæŠ€æœ¯/æ–¹æ³•]
> âš¡ **å…³é”®è¯**ï¼š[æŠ€æœ¯æ ˆæˆ–é‡è¦æ¦‚å¿µ]

---

## ğŸŒŸ ä¸ºä»€ä¹ˆé€‰æ‹© [æŠ€æœ¯åç§°]ï¼Ÿ

[ä¸ªäººè§‚ç‚¹å’Œæ¨èç†ç”±ï¼Œå¯ä»¥åŒ…å«ä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”]

### âœ… ä¸»è¦ä¼˜åŠ¿

- **[ä¼˜åŠ¿ä¸€]**ï¼š[å…·ä½“è¯´æ˜]
- **[ä¼˜åŠ¿äºŒ]**ï¼š[å…·ä½“è¯´æ˜]
- **[ä¼˜åŠ¿ä¸‰]**ï¼š[å…·ä½“è¯´æ˜]

### âš ï¸ æ³¨æ„äº‹é¡¹

- [éœ€è¦æ³¨æ„çš„ç‚¹]
- [å¯èƒ½çš„é™åˆ¶]

---

## ğŸ”§ å®‰è£…é…ç½®æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼š[æ­¥éª¤åç§°]

\`\`\`bash
# å…·ä½“å‘½ä»¤
# è¯¦ç»†æ³¨é‡Š
\`\`\`

### ç¬¬äºŒæ­¥ï¼š[æ­¥éª¤åç§°]

\`\`\`bash
# é…ç½®å‘½ä»¤
\`\`\`

âš ï¸ **é‡è¦æç¤º**ï¼š[å…³é”®æ³¨æ„äº‹é¡¹]

---

## ğŸ“ é…ç½®æ–‡ä»¶è¯¦è§£

### [é…ç½®æ–‡ä»¶å]

\`\`\`language
# å®Œæ•´çš„é…ç½®æ–‡ä»¶å†…å®¹
# æ¯è¡Œéƒ½æœ‰è¯´æ˜
\`\`\`

---

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹

### åœºæ™¯ï¼š[å…·ä½“ä½¿ç”¨åœºæ™¯]

**é—®é¢˜æè¿°**ï¼š[è¦è§£å†³ä»€ä¹ˆé—®é¢˜]

**è§£å†³æ–¹æ¡ˆ**ï¼š

\`\`\`language
// å®Œæ•´çš„ä»£ç ç¤ºä¾‹
// è¯¦ç»†æ³¨é‡Š
\`\`\`

**éªŒè¯æ­¥éª¤**ï¼š

\`\`\`bash
# éªŒè¯å‘½ä»¤
\`\`\`

---

## ğŸ” æ•…éšœæ’æŸ¥æŒ‡å—

### å¸¸è§é—®é¢˜ 1ï¼š[é—®é¢˜æè¿°]

**ç—‡çŠ¶**ï¼š[å…·ä½“è¡¨ç°]

**è§£å†³æ–¹æ¡ˆ**ï¼š

\`\`\`bash
# è§£å†³å‘½ä»¤
\`\`\`

### å¸¸è§é—®é¢˜ 2ï¼š[é—®é¢˜æè¿°]

**åŸå› **ï¼š[é—®é¢˜åŸå› ]

**è§£å†³æ–¹æ³•**ï¼š[å…·ä½“æ­¥éª¤]

---

## ğŸ“Š å¯¹æ¯”åˆ†æ

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| [æ–¹æ¡ˆä¸€] | [ä¼˜ç‚¹] | [ç¼ºç‚¹] | [åœºæ™¯] |
| [æ–¹æ¡ˆäºŒ] | [ä¼˜ç‚¹] | [ç¼ºç‚¹] | [åœºæ™¯] |

---

## ğŸš€ æœ€ä½³å®è·µä¸ä¼˜åŒ–æŠ€å·§

### ğŸ’¡ æŠ€å·§ä¸€ï¼š[æŠ€å·§åç§°]

[å…·ä½“è¯´æ˜å’Œä»£ç ç¤ºä¾‹]

### ğŸ’¡ æŠ€å·§äºŒï¼š[æŠ€å·§åç§°]

[å…·ä½“è¯´æ˜]

---

## ğŸ“‹ å¸¸ç”¨ç®¡ç†å‘½ä»¤

\`\`\`bash
# æŸ¥çœ‹çŠ¶æ€
[å‘½ä»¤]

# é‡å¯æœåŠ¡
[å‘½ä»¤]

# æŸ¥çœ‹æ—¥å¿—
[å‘½ä»¤]
\`\`\`

---

> ğŸ‰ **æ€»ç»“**ï¼š[ç®€æ´çš„æ€»ç»“å’Œä½¿ç”¨å»ºè®®]
\`\`\`

## ç”ŸæˆæŒ‡ä»¤

è¯·æ ¹æ®ä»¥ä¸Šè¦æ±‚ï¼Œå°†æˆ‘æ¥ä¸‹æ¥æä¾›çš„åŸå§‹å­¦ä¹ å†…å®¹è½¬åŒ–ä¸ºä¸€ä»½å®Œæ•´ã€å®ç”¨ã€æœ‰ä¸ªäººç‰¹è‰²çš„æŠ€æœ¯ç¬”è®°ã€‚ç¡®ä¿ï¼š
ä¸€ã€
1. ä¿æŒåŸå§‹å†…å®¹çš„æ ¸å¿ƒä¿¡æ¯ï¼Œå¹¶è¡¥å……å®Œæ•´çš„æ“ä½œæµç¨‹
2. æä¾›å¯ç›´æ¥ä½¿ç”¨çš„å‘½ä»¤ã€é…ç½®æ–‡ä»¶å’Œä»£ç ç¤ºä¾‹
3. åŒ…å«æ•…éšœæ’æŸ¥å’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ
4. ä½¿ç”¨ç”ŸåŠ¨æœ‰è¶£çš„è¯­è¨€é£æ ¼ï¼Œé€‚å½“åŠ å…¥ä¸ªäººè§‚ç‚¹
5. é‡ç‚¹çªå‡ºå®ç”¨æ€§ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½è¦å¯æ“ä½œ
6. å–„ç”¨emojiå’Œè§†è§‰å…ƒç´ å¢å¼ºå¯è¯»æ€§
äºŒã€
1. ä½ ä¹Ÿå¯ä»¥è¡¥å……ç›¸å…³çŸ¥è¯†æˆ–è§è§£ã€‚
2. ä½ è¿”å›çš„å›ç­”å†…å®¹å¿…é¡»å…¨éƒ¨éƒ½æ˜¯mdæ ¼å¼çš„å†…å®¹ï¼Œå¹¶ä¸”è¿”å›çš„æ˜¯ è¾“å‡º Markdown åŸæ–‡ï¼Œä¸è¦å°†æ‰€æœ‰å›ç­”æ”¾åˆ°Markdownä»£ç å—ä¸­ï¼Œå¹¶ä¸”åªèƒ½åŒ…å«å’Œè¿™ç¯‡ç¬”è®°æœ‰å…³çš„å†…å®¹ã€‚
3. ä½ åº”è¯¥è®¤çœŸã€ä»”ç»†ã€å…¨é¢é˜…è¯»å†…å®¹ï¼ŒåŒ…æ‹¬å†…å®¹ä¸­çš„é“¾æ¥ç­‰ã€‚
4. ç¬”è®°åº”è¯¥ä»¥ç¬¬ä¸€äººç§°è§†è§’é£æ ¼å‘ˆç°ï¼Œä½†ä¸è¦ä½¿ç”¨"æˆ‘"ã€"æˆ‘ä»¬"ç­‰å­—çœ¼ã€‚
5. å’Œç®—æ³•ç›¸å…³ï¼Œåˆ™ä½¿ç”¨cppå®ç°ã€‚
6. å¯ä»¥é€‚å½“ä½¿ç”¨è‹±æ–‡ã€‚

ç°åœ¨è¯·å¼€å§‹å¤„ç†æˆ‘çš„åŸå§‹å­¦ä¹ å†…å®¹ï¼š

${prompt}`

  const req = {
    contents: [
      {
        role: 'user',
        parts: [{ text: fullPrompt }],
      },
    ],
  }

  return await generativeModel.generateContentStream(req)
}

// ç”Ÿæˆç¬”è®°æ ‡é¢˜
export async function generateNoteTitle(content: string) {
  const vertexAI = new VertexAI({
    project: GOOGLE_CLOUD_PROJECT,
    location: GOOGLE_CLOUD_LOCATION,
  })

  const generativeModel = vertexAI.getGenerativeModel({
    model: MODEL_NAME || '',
  })

  const titlePrompt = `è¯·ä¸ºä»¥ä¸‹Markdownå†…å®¹ç”Ÿæˆä¸€ä¸ªç®€æ´ã€å‡†ç¡®çš„æ ‡é¢˜ï¼ˆä¸è¶…è¿‡50ä¸ªå­—ç¬¦ï¼‰ï¼Œæ³¨æ„ä½ è¿”å›çš„å†…å®¹å¿…é¡»æ˜¯çº¯æ–‡æœ¬ï¼Œå°½é‡åŒ…å«è‹±æ–‡ã€‚

å†…å®¹ï¼š
${content.slice(0, 1000)}`

  const req = {
    contents: [
      {
        role: 'user',
        parts: [{ text: titlePrompt }],
      },
    ],
  }

  try {
    const response = await generativeModel.generateContent(req)
    return (
      response.response?.candidates?.[0]?.content?.parts?.[0]?.text ||
      'æ–°å»ºç¬”è®°'
    )
  } catch (error) {
    console.error('Error generating title:', error)
    return 'æ–°å»ºç¬”è®°'
  }
}

// æ–‡ä»¶å†…å®¹ç”Ÿæˆï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
export async function generateContentFromFile(
  prompt: string,
  fileType?: string,
  gcsUri?: string
) {
  const vertexAI = new VertexAI({
    project: GOOGLE_CLOUD_PROJECT,
    location: GOOGLE_CLOUD_LOCATION,
  })

  const generativeModel = vertexAI.getGenerativeModel({
    model: MODEL_NAME || '',
  })

  const parts = [] as any[]
  if (gcsUri && fileType) {
    parts.push({
      fileData: {
        fileUri: gcsUri,
        mimeType: fileType,
      },
    })
  }
  if (prompt) {
    parts.push({ text: prompt })
  }

  const req = { contents: [{ role: 'user', parts }] }
  const resp = await generativeModel.generateContentStream(req)
  const contentResponse = await resp.response
  return contentResponse?.candidates?.[0]?.content?.parts?.[0]?.text || ''
}
